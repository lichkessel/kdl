<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="./shared-styles.html">
<link rel="import" href="./expand-button.html">

<dom-module id="student-list">
  <template>
    <style include="shared-styles"></style>
    <!-- url="https://jsonplaceholder.typicode.com/posts"  -->
    <iron-ajax id="get"
      url="http://seerio.us/kdlproxy/students"
      on-response="_onGetStudentsResponse"
      on-error="_onError"
      content-type="application/json"
      ></iron-ajax>

    <a id="topfocus"></a>

    <paper-material class="card-holder">
      <template name="student-repeat" is="dom-repeat" items="{{students}}" as="student">
        <div class="list-item" 
            key$="[[student._id]]" editing$="[[student._editing]]" viewing$="[[!student._editing]]">
          <form is="iron-form">
            <div class="list-row title content">
              <div class="control" style="flex-grow:1">
                <div class="text">
                  <p>[[student.fullName]]</p>
                </div>
                <paper-input class="input" value="{{student.fullName}}" label="Full name" size="40" required error-message="Required" dir="rtl" disabled="[[!student._editing]]"></paper-input>
              </div>
              <expand-button opened="{{student._expanded}}" on-close="_onCancel"></expand-button>
            </div>
            <iron-collapse opened="[[student._expanded]]">
              <div class="list-column">
                  <div class="list-column content">

                    <div class="control">
                      <div class="text">
                        <label>Phone</label>
                        <p>[[student.phoneNumber]]</p>
                      </div>
                      <paper-input class="input" label="Phone" value="{{student.phoneNumber}}" required error-message="Required" dir="rtl" disabled="[[!student._editing]]"></paper-input>
                    </div>
                  </div>
                <div class="form-controls">
                  <paper-button class="edit" on-tap="_onEditMode"><iron-icon icon="create"></iron-icon>Edit</paper-button>
                  <paper-button class="save" on-tap="_onSave">Save</paper-button>
                  <paper-button class="drop" on-tap="_onDropStudent"><iron-icon icon="delete"></iron-icon>Delete</paper-button>
                  <iron-ajax name="createStudent"
                    url="http://seerio.us/kdlproxy/students"
                    on-response="_onUpdateResponse"
                    on-error="_onError"
                    content-type="application/json"
                    method="POST"
                    ></iron-ajax>
                  <iron-ajax name="dropStudent"
                    url="http://seerio.us/kdlproxy/students/[[student._id]]"
                    on-response="_onDropResponse"
                    on-error="_onModifyError"
                    content-type="application/json"
                    method="DELETE"
                    ></iron-ajax>
                  <iron-ajax name="updateStudent"
                    url="http://seerio.us/kdlproxy/students/[[student._id]]"
                    on-response="_onUpdateResponse"
                    on-error="_onModifyError"
                    content-type="application/json"
                    method="PUT"
                    ></iron-ajax>
                </div>
              </div>
            </iron-collapse>
          </form>
        </div>
      </template>
    </paper-material>
    <div class="add-button">
        <div>
          <paper-fab icon="add" on-tap="_onAddNew"></paper-fab>
        </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'student-list',
      properties : {
        students : {
          type: Array,
          notify: true,
          value : []
        },
        loading : {
          type: Boolean,
          notify:true,
          value: false
        }
      }
      /*
       *
       *  Server responses
       *
       */
      ,_onUpdateResponse : function(e) {
        if(!e.detail.response.message) {
          var c = e.detail.response;
          e.model.set('student._id',c._id);
          //TODEL:
          //e.model.set('student._id','111');
        } else {
          e.model.set('student._editing',true);
          this.fire('page-error',{ message: e.detail.response.message } );
        }
      }
      ,_onDropResponse : function(e) {
        if(!e.detail.response.message) {
          this.arrayDelete('students',e.model.student);
        } else {
          e.model.set('student._editing',true);
          this.fire('page-error',{ message: e.detail.response.message } );
        }
      }
      ,_onGetStudentsResponse : function(e) {
        this.domHost.set('loaded',true);
        if(!e.detail.response.message) {
          //TODEL:
          /*e.detail.response.forEach(function(x,i) { 
            x._id = ''+(1+i); 
            x.fullName = 'John Pearpeach'; 
            x.phoneNumber = '+1-800-123-01-21';
          });*/

          e.detail.response.forEach(function(x) { 
            x._editing = false ; 
          });
          this.set('students', e.detail.response);
        } else {
          this.fire('page-error',{ message: e.detail.response.message } );
        }
      }
      ,_onError : function(e) {
        this.fire('page-error',{ message: 'Network problems! Try again later' } );
      }
      ,_onModifyError : function(e) {
        e.model.set('student._editing',true);
        this.fire('page-error',{ message: "Server can't modifify this student" } );
      }
      /*
       *
       *  Commands execution
       *
       */
      ,_onAddNew : function() {
        this.unshift('students',{
          _editing : true,
          _expanded : true
        })
      }
      ,_onDropStudent : function(e) {
         //drop student
        if(e.model.student._id === undefined) {
          this.arrayDelete('students',e.model.student);
        } else {
          var self = this;
          this.fire('confirm',{ 
            text: 'Do you really want to delete this student?', 
            ok : function() {
              console.log('drop student');
              var ajax = self.$$('.list-item[key="'+e.model.student._id+'"] [name="dropStudent"]');
              ajax.body = '';
              ajax.generateRequest();
            } 
          }); 
        }
      }
      ,_onEditMode : function(e) {
        e.model._originalStudentItem_ = JSON.parse(JSON.stringify(e.model.student));
        e.model.set('student._editing',true);
      }
      ,_onSave : function(e) {
        var model = e.model;
        var student = e.model.student;
        model.set('student._editing', false);
        if(student._id === undefined) {
          //create student
          console.log('create student');
          var ajax = e.target.parentNode.querySelector('[name="createStudent"]');
          ajax.body = JSON.stringify({
                fullName :  student.fullName,
                phoneNumber : student.phoneNumber
              });
          ajax.generateRequest();          
        } else if(student._id !== undefined) {
          //update student
          console.log('update student');
          var ajax = this.$$('.list-item[key="'+student._id+'"] [name="updateStudent"]');
          ajax.body = JSON.stringify({
                fullName :  student.fullName,
                phoneNumber : student.phoneNumber
              });
          ajax.generateRequest();
        } else {
          //cleanup
          this._onCancel(e);
        }
      }
      ,_onCancel : function(e) {
        console.log('cancel student');
        if(e.model.student._id === undefined) {
          this.arrayDelete('students',e.model.student);
        } else {
          for(var i in e.model._originalStudentItem_) {
            e.model.set('student.'+i,e.model._originalStudentItem_[i]);
          }
          e.model.set('student._editing', false);
        }
        delete this._originalStudentItem_;
      }
      ,load : function() {
        this.$.get.generateRequest();
      }
    });
  </script>
</dom-module>