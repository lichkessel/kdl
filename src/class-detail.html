<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">


<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">


<link rel="import" href="./owed-list.html">

<dom-module id="class-detail">
  <template>
    <style include="shared-styles"></style>
    <!--iron-ajax id="ajax"
      url="http://api.kdl.co.il:7999/classes/[[classItem._id]]" 
      last-response="{{classItem.students}}"
      last-error="{{error}}"
      on-response="_onResponse"></iron-ajax-->

    <form is="iron-form" content-type="application/json">
      <paper-material class="card-holder">
        <div class="form-inputs" hidden$="[[!classItem._new]]">
          <paper-input name="name" label="Class name" value="{{classItem.className}}" required error-message="Required" dir="rtl"></paper-input>
        </div>

        <paper-fab class="add-item-button" and-hidden-1$="[[!classItem._new]]" and-hidden-2$="[[!classItem._editing]]" icon="add" on-tap="_addNew"></paper-fab>

        <template is="dom-repeat" items="{{classItem.students}}" >
          <div class="list-item">

            <div class="card">
              <div class="card-text" hidden$="[[item._toggled]]">[[item.student.fullName]]</div>
              <paper-spinner class="toggle-spinner" active or-hidden-1$="[[!item._expanded]]" or-hidden-2$="[[item._ready]]"></paper-spinner>
              <div class="card-toggle">
                <paper-icon-button class="expand-card" icon$="[[iconToggle(item._expanded)]]" on-tap="_toggleStudent"></paper-icon-button>
              </div>
            </div>

            <iron-collapse class="card-form" opened="[[item._ready]]">
              <div>
                <owed-list student="{{item}}"></owed-list>
              </div>
            </iron-collapse>

          </div>
        </template>
        <div class="form-controls" and-hidden-1$="[[!classItem._new]]" and-hidden-2$="[[!classItem._editing]]">
          <paper-button class="save" on-tap="_submitCard">
            <div hidden$="{{classItem._sending}}">Save</div>
            <div hidden$="{{!classItem._sending}}">Saving</div>
          </paper-button>
        </div>
      </paper-material>
    </form>

  </template>
  <script>
    Polymer({
      is : "class-detail"
      ,properties : {
        classItem : {
          type:Object
          ,notify:true
        }
        ,title : {
          type:String
          ,computed:'_classTitle(classItem.className)'
        }
        ,backButton : {
          type: Boolean
          ,value: true
        }
      }
      /*,_onResponse : function(e) {
        this.fire('page-ready', { title: this.classItem.className, backButton: true });
      }
      ,_onError : function(e) {

      }*/
      ,_classTitle : function(name) {
        this.domHost.set('title',name);
        return name || '';
      }
      ,empty : function(arr) {
        return !arr.length;
      }
      ,iconToggle : function(exp) {
        return exp ? 'expand-less' : 'expand-more';
      }
      ,_toggleStudent : function(e) {
        e.model.set('item._expanded', !e.model.item._expanded);
        e.model.set('item._ready', false);
      }
      ,_toggleOwed : function(e) {
        e.model.set('item.expanded', !e.model.item.expanded);
      }
      ,_addNew : function(e) {

      }
      ,_back : function() {
        this.set('classItem', null);
        this.domHost.set('page', 'class-list');
      }
      ,load : function() {
        this.domHost.set('loaded',true);
      }
    });
  </script>
</dom-module>