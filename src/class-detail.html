<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">


<link rel="import" href="./owed-list.html">

<dom-module id="class-detail">
  <template>
    <style include="shared-styles"></style>
    <!--iron-ajax id="ajax"
      url="http://api.kdl.co.il:7999/classes/[[classItem._id]]" 
      last-response="{{classItem.students}}"
      last-error="{{error}}"
      on-response="_onResponse"></iron-ajax-->

    <paper-material class="card-holder">
      <div class="empty-container" hidden$="[[classItem.students.length]]">There are no students yet</div>
      <template is="dom-repeat" items="{{classItem.students}}" >
        <div class="list-item">

          <div class="card">
            <div class="card-text" hidden$="[[item._toggled]]">[[item.student.fullName]]</div>
            <paper-spinner class="toggle-spinner" active or-hidden-1$="[[!item._expanded]]" or-hidden-2$="[[item._ready]]"></paper-spinner>
            <div class="card-toggle">
              <paper-icon-button class="expand-card" icon$="[[iconToggle(item._expanded)]]" on-tap="_toggleStudent"></paper-icon-button>
            </div>
          </div>

          <iron-collapse class="card-form" opened="[[item._ready]]">
            <div>
              <owed-list student="{{item}}"></owed-list>
            </div>
          </iron-collapse>

        </div>
      </template>

    </paper-material>

    <paper-fab class="add-button" icon="add" on-tap="_addNew"></paper-fab>

  </template>
  <script>
    Polymer({
      is : "class-detail"
      ,properties : {
        classItem : {
          type:Object
          ,notify:true
        }
      }
      ,listeners : {
        'do-load-page' : '_loadPage'
      }
      ,ready : function() {
        this.fire('component-loaded','class-detail');
      }
      ,_loadPage : function(e) {
        this.set('classItem', e.detail.item);
        console.log(e.detail.item);
        this.fire('page-ready', { title: this.classItem.className, backButton: true });
        //this.$.ajax.generateRequest();
      }
      /*,_onResponse : function(e) {
        this.fire('page-ready', { title: this.classItem.className, backButton: true });
      }
      ,_onError : function(e) {

      }*/
      ,iconToggle : function(exp) {
        return exp ? 'expand-less' : 'expand-more';
      }
      ,_toggleStudent : function(e) {
        e.model.set('item._expanded', !e.model.item._expanded);
        e.model.set('item._ready', false);
      }
      ,_toggleOwed : function(e) {
        e.model.set('item.expanded', !e.model.item.expanded);
      }
    });
  </script>
</dom-module>