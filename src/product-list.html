<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="./shared-styles.html">
<link rel="import" href="./expand-button.html">

<dom-module id="product-list">
  <template>
    <style include="shared-styles"></style>

    <!-- url="http://seerio.us/kdlproxy/products"  -->
    <iron-ajax id="get"
      url="https://jsonplaceholder.typicode.com/posts"
      on-response="_onGetProductsResponse"
      on-error="_onGetError"
      ></iron-ajax>

    <a id="topfocus"></a>

    <paper-material class="card-holder">
      <template name="product-repeat" is="dom-repeat" items="{{products}}" as="product">
        <div class="list-item" 
            key$="[[product._id]]" editing$="[[product._editing]]" viewing$="[[!product._editing]]">
          <form is="iron-form">
            <div class="list-row title content">
              <div class="control" style="flex-grow:1">
                <div class="text">
                  <p>[[product.name]]</p>
                </div>
                <paper-input class="input" value="{{product.name}}" size="50" required error-message="Required" dir="rtl"></paper-input>
              </div>
              <expand-button opened="{{product._expanded}}" on-close="_onCancel"></expand-button>
            </div>
            <iron-collapse opened="[[product._expanded]]">
              <div class="list-column">
                  <div class="list-column content">

                    <div class="control">
                      <div class="text">
                        <label>Price</label>
                        <p>[[product.price]]</p>
                      </div>
                      <paper-input class="input" label="Price" value="{{product.price}}" required error-message="Required" dir="rtl"></paper-input>
                    </div>

                    <div class="control">
                      <div class="text">
                        <label>Billing period</label>
                        <p>[[product.billingPeriod]]</p>
                      </div>
                      <paper-dropdown-menu class="input" label="Billing period"  value="{{product.billingPeriod}}" required error-message="Required" dir="rtl">
                        <paper-listbox attr-for-selected="val" selected="[[product.billingPeriod]]" class="dropdown-content">
                          <paper-item val="weekly">weekly</paper-item>
                          <paper-item val="monthly">monthly</paper-item>
                          <paper-item val="quartal">quartal</paper-item>
                          <paper-item val="year">year</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>

                  </div>
                <div class="form-controls">
                  <paper-button class="edit" on-tap="_onEditMode"><iron-icon icon="create"></iron-icon>Edit</paper-button>
                  <paper-button class="save" on-tap="_onSave">Save</paper-button>
                  <paper-button class="drop" on-tap="_onDropProduct"><iron-icon icon="delete"></iron-icon>Delete</paper-button>
                </div>
              </div>
            </iron-collapse>
          </form>
          <iron-ajax name="createProduct"
            url="https://jsonplaceholder.typicode.com/posts/"
            on-response="_onUpdateResponse"
            on-error="_onModifyError"
            method="POST"
            ></iron-ajax>
          <iron-ajax name="dropProduct"
            url="https://jsonplaceholder.typicode.com/posts/[[product._id]]"
            on-response="_onDropResponse"
            on-error="_onModifyError"
            method="DELETE"
            ></iron-ajax>
          <iron-ajax name="updateProduct"
            url="https://jsonplaceholder.typicode.com/posts/[[product._id]]"
            on-response="_onUpdateResponse"
            on-error="_onModifyError"
            method="PUT"
            ></iron-ajax>
        </div>
      </template>
    </paper-material>
    <div class="add-button">
        <div>
          <paper-fab icon="add" on-tap="_addNew"></paper-fab>
        </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'product-list',
      properties : {
        products : {
          type: Array,
          notify: true,
          value : []
        },
        loading : {
          type: Boolean,
          notify:true,
          value: false
        }
      }
      /*
       *
       *  Server responses
       *
       */
      ,test : function(e) {
        console.log(e);
       }
      ,_onUpdateResponse : function(e) {
        if(!e.detail.response.message) {
          var c = e.detail.response;
          e.model.set('product._id',c._id);
          //TODEL:
          e.model.set('product._id','111');
        } else {
          e.model.set('product._editing',true);
          this.fire('page-error',{ message: e.detail.response.message } );
        }
      }
      ,_onDropResponse : function(e) {
        if(!e.detail.response.message) {
          this.arrayDelete('products',e.model.product);
        } else {
          e.model.set('product._editing',true);
          this.fire('page-error',{ message: e.detail.response.message } );
        }
      }
      ,_onGetProductsResponse : function(e) {
        this.domHost.set('loaded',true);
        if(!e.detail.response.message) {
          //TODEL:
          e.detail.response.forEach(function(x,i) { 
            x._id = ''+(1+i); 
            x.name = 'Kfar Yehezkel 2 Times a week'; 
            x.price = '1000';
            x.billingPeriod = 'monthly';
          });

          e.detail.response.forEach(function(x) { 
            x._editing = false ; 
          });
          this.set('products', e.detail.response);
        } else {
          this.fire('page-error',{ message: e.detail.response.message } );
        }
      }
      ,_onGetError : function(e) {
        this.fire('page-error',{ message: 'Network problems! Try again later' } );
      }
      ,_onModifyError : function(e) {
        e.model.set('product._editing',true);
        this.fire('page-error',{ message: "Server can't modifify this product" } );
      }
      /*
       *
       *  Commands execution
       *
       */
      ,_onDropProduct : function(e) {
         //drop product
        if(e.model.product._id === undefined) {
          this.arrayDelete('products',e.model.product);
        } else {
          var self = this;
          this.fire('confirm',{ 
            text: 'Do you really want to delete this product?', 
            ok : function() {
              console.log('drop product');
              var ajax = self.$$('.list-item[key="'+e.model.product._id+'"] [name="dropProduct"]');
              ajax.body = '';
              ajax.generateRequest();
            } 
          }); 
        }
      }
      ,_onEditMode : function(e) {
        e.model._originalProductItem_ = JSON.parse(JSON.stringify(e.model.product));
        e.model.set('product._editing',true);
      }
      ,_onSave : function(e) {
        var model = e.model;
        var product = e.model.product;
        var item = this.$$('.list-item[key="'+product._id+'"]');
        model.set('product._editing', false);
        if(product._id === undefined) {
          //create product
          console.log('create product');
          var ajax = item.querySelector('[name="addProduct"]');
          ajax.body = JSON.stringify({
                fullName :  product.fullName,
                phoneNumber : product.phoneNumber
              });
          ajax.generateRequest();          
        } else if(product._id !== undefined) {
          //update product
          console.log('update product');
          var ajax = item.querySelector('[name="updateProduct"]');
          ajax.body = JSON.stringify({
                fullName :  product.fullName,
                phoneNumber : product.phoneNumber
              });
          ajax.generateRequest();
        } else {
          //cleanup
          this._onCancel(e);
        }
      }
      ,_onCancel : function(e) {
        console.log('cancel product');
        if(e.model.product._id === undefined) {
          this.arrayDelete('products',e.model.product);
        } else {
          for(var i in e.model._originalProductItem_) {
            e.model.set('product.'+i,e.model._originalProductItem_[i]);
          }
          e.model.set('product._editing', false);
        }
        delete this._originalProductItem_;
      }
      ,load : function() {
        this.$.get.generateRequest();
      }
    });
  </script>
</dom-module>